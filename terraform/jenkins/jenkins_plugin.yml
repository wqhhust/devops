- name: Playbook to Install Packages
  hosts:
    - prod
  vars:
    home_dir: /home/ubuntu
    jenkins_version: "2.263.4"

  tasks:

    - name: Update JENKINS_JAVA_OPTIONS
      become: yes
      lineinfile:
        path: /etc/default/jenkins
        regexp: ".*-Djava.awt.headless=true.*"
        line: 'JENKINS_JAVA_OPTIONS="-Djava.awt.headless=true -Djava.net.preferIPv4Stack=true -Djenkins.install.runSetupWizard=false'
        state: present

    - name: Copy the plugins.yaml file
      copy:
        dest: "{{ home_dir }}/plugins.yaml"
        src: "jenkins/jenkins_plugins.yaml"

    - name: download jenkins plugin manager
      get_url:
        url: https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/2.12.11/jenkins-plugin-manager-2.12.11.jar
        dest: "{{ home_dir }}/jenkins-plugin-manager.jar"

    - name: stop jenkins
      service:
        name: jenkins
        state: stopped

    - name: run the jenkins-plugin-manager
      become: yes
      command: "java -jar {{ home_dir }}/jenkins-plugin-manager.jar --plugin-file plugins.yaml --plugin-download-directory /var/lib/jenkins/plugins"

    - name: update JENKINS_HOME ownership # since download manager will store file as root
      become: yes
      file:
        path: /var/lib/jenkins
        owner: jenkins
        group: jenkins
        state: directory
        recurse: yes

    - name: restart jenkins
      service:
        name: jenkins
        state: restarted
